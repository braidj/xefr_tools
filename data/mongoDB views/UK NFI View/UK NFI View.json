[
    {
     $match: {
      schemaId: $id{TSP UK Invoice Tracker}
     }
    },
    {
     $project: {
      id: 1,
      schemaId: $id{UK NFI View},
      $id{UK NFI View.Candidate}: $$id{TSP UK Invoice Tracker.Candidate},
      $id{UK NFI View.CompanyName}: $$id{TSP UK Invoice Tracker.CompanyName},
      $id{UK NFI View.Placement}: { $toString: $$id{TSP UK Invoice Tracker.Placement} },
      $id{UK NFI View.InvoiceDate}: $$id{TSP UK Invoice Tracker.InvoiceDate},
      $id{UK NFI View.Currency}: $$id{TSP UK Invoice Tracker.Currency},
      $id{UK NFI View.LinePrice}: $$id{TSP UK Invoice Tracker.LinePrice},
      $id{UK NFI View.ChargeCode}: $$id{TSP UK Invoice Tracker.ChargeCode},
      $id{UK NFI View.Source}: $$id{TSP UK Invoice Tracker.Source},
      $id{UK NFI View.Country}: $$id{TSP UK Invoice Tracker.Country}
     }
    },
    {
     $unionWith: {
      coll: "dataInstances",
      pipeline: [
       {
        $match: {
         schemaId: $id{TSP UK Contractor Invoices Tracker}
        }
       },
       {
        $project: {
         id: 1,
         schemaId: $id{UK NFI View},
         $id{UK NFI View.Candidate}: $$id{TSP UK Contractor Invoices Tracker.Candidate},
         $id{UK NFI View.CompanyName}: $$id{TSP UK Contractor Invoices Tracker.CompanyName},
         $id{UK NFI View.Placement}: { $toString: $$id{TSP UK Contractor Invoices Tracker.Placement} },
         $id{UK NFI View.InvoiceDate}: $$id{TSP UK Contractor Invoices Tracker.InvoiceDate},
         $id{UK NFI View.Currency}: $$id{TSP UK Contractor Invoices Tracker.Currency},
         $id{UK NFI View.LinePrice}: $$id{TSP UK Contractor Invoices Tracker.LinePrice},
         $id{UK NFI View.ChargeCode}: $$id{TSP UK Contractor Invoices Tracker.ChargeCode},
         $id{UK NFI View.Source}: $$id{TSP UK Contractor Invoices Tracker.Source},
         $id{UK NFI View.Country}: $$id{TSP UK Contractor Invoices Tracker.Country}
        }
       }
      ]
     }
    },
    {
     $unionWith: {
      coll: "dataInstances",
      pipeline: [
       {
        $match: {
         schemaId: $id{Metrics UK NFI Adjustments}
        }
       },
       {
        $project: {
         id: 1,
         schemaId: $id{UK NFI View},
         $id{UK NFI View.Candidate}: $$id{Metrics UK NFI Adjustments.Candidate},
         $id{UK NFI View.CompanyName}: $$id{Metrics UK NFI Adjustments.CompanyName},
         $id{UK NFI View.Placement}: { $toString: $$id{Metrics UK NFI Adjustments.Placement} },
         $id{UK NFI View.InvoiceDate}: $$id{Metrics UK NFI Adjustments.InvoiceDate},
         $id{UK NFI View.Currency}: $$id{Metrics UK NFI Adjustments.Currency},
         $id{UK NFI View.LinePrice}: $$id{Metrics UK NFI Adjustments.LinePrice},
         $id{UK NFI View.ChargeCode}: $$id{Metrics UK NFI Adjustments.ChargeCode},
         $id{UK NFI View.Source}: $$id{Metrics UK NFI Adjustments.Source}
        }
       }
      ]
     }
    },
    {
     $set: {
      $id{UK NFI View.Year}: { $dateToString: { format: "%Y", date: { $toDate: $$id{UK NFI View.InvoiceDate} } } },
      $id{UK NFI View.Month}: { $concat: [{ $dateToString: { format: "%m", date: { $toDate: $$id{UK NFI View.InvoiceDate} } } }, "-", { $arrayElemAt: [["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"], { $month: { $toDate: $$id{UK NFI View.InvoiceDate} } }] }] },
      $id{UK NFI View.Day}: { $dayOfMonth: { $toDate: $$id{UK NFI View.InvoiceDate} } },
      $id{UK NFI View.Quarter}: { $concat: ["Q", { $arrayElemAt: [["", "1", "1", "1", "2", "2", "2", "3", "3", "3", "4", "4", "4"], { $month: { $toDate: $$id{UK NFI View.InvoiceDate} } }] }] },
      $id{UK NFI View.Multiplier}: { $cond: { if: { $eq: [$$id{UK NFI View.Source}, "TSP UK Contractor Invoices"] }, then: -1, else: 1 } }
     }
    },
    {
     $set: {
      fxLookup: {
       $concat: [
        { $toString: $$id{UK NFI View.Year} },
        { $toString: $$id{UK NFI View.Month} },
        { $toString: $$id{UK NFI View.Day} },
        { $toString: $$id{UK NFI View.Currency} }
       ]
      }
     }
    },
    {
     $lookup: {
      from: "dataInstances",
      localField: "fxLookup",
      foreignField: "compoundIndexValues._id{Metrics GBP Forex Daily}.gbpFXLookup",
      as: "exchangeRates"
     }
    },
    {
     $set: {
      "firstRate": { $arrayElemAt: ["$exchangeRates", 0] }
     }
    },
    {
     $set: {
      $id{UK NFI View.ExchangeRate}: { $cond: [ { $eq: [$$id{UK NFI View.Currency}, "Â£"] } , 1, "$firstRate._id{Metrics GBP Forex Daily.GBP Rate}" ] }
     }
    },
    {
     $unset: ["exchangeRates", "firstRate", "fxLookup"]
    },
    {
     $set: {
      consultantLookup: {
       $concat: [
        { $toString: $$id{UK NFI View.Placement} },
        { $toString: $$id{UK NFI View.Candidate} }
       ]
      }
     }
    },
    {
     $set: { $id{UK NFI View.PlacementCandidateLookup}: "$consultantLookup" }
    },
    {
     $lookup: {
      from: "dataInstances",
      localField: "consultantLookup",
      foreignField: "compoundIndexValues._id{TSP UK Placements Tracker}.placementCandidateLookup",
      as: "consultants"
     }
    },
    {
     $set: {
      "firstConsultant": { $arrayElemAt: ["$consultants", 0] }
     }
    },
    {
     $set: {
      $id{UK NFI View.Consultant}: "$firstConsultant._id{TSP UK Placements Tracker.Consultant}"
     }
    },
    {
     $unset: ["consultants", "firstConsultant", "consultantLookup"]
    },
    {
     $lookup: {
      from: "dataInstances",
      localField: $id{UK NFI View.ChargeCode},
      foreignField: $id{Metrics Charge Codes.ChargeCode},
      as: "types"
     }
    },
    {
     $set: {
      "firstType": { $arrayElemAt: ["$types", 0] }
     }
    },
    {
     $set: {
      $id{UK NFI View.Type}: "$firstType._id{Metrics Charge Codes.Type}"
     }
    },
    {
     $unset: ["types", "firstType"]
    },
    {
     $set: {
      $id{UK NFI View.GBPLinePrice}: {
       $cond: {
        if: { $gt: [$$id{UK NFI View.ExchangeRate}, 1] },
        then: { $multiply: [ $$id{UK NFI View.Multiplier}, { $divide: [$$id{UK NFI View.LinePrice}, $$id{UK NFI View.ExchangeRate}] } ]},
        else: { $multiply: [ $$id{UK NFI View.Multiplier}, { $multiply: [$$id{UK NFI View.LinePrice}, $$id{UK NFI View.ExchangeRate}] } ]}
       }
      }
     }
    }
   ]