[
    {
        $match: {
            schemaId: $id{Metrics GBP Forex Daily}
        }
    },
    {
        $project: {
           id:"1",
           schemaId: $id{Forecast Currencies View},
           $id{Forecast Currencies View.Symbol}: $$id{Metrics GBP Forex Daily.Symbol}

        }
    },
    /* Get last available symbol rate */
    {
        $lookup: {
            from: "dataInstances",
            localField: $id{Forecast Currencies View.Symbol},
            foreignField: $id{Metrics GBP Forex Daily.Symbol},
            pipeline: [
                {
                    $sort: {
                            "compoundIndexValues._id{Metrics GBP Forex Daily}.gbpFXLookup": -1
                    }
                },
                {
                    $limit: 1
                }
                ],
            as: "ForecastExchangeRates"
        }

    },
    {
        $set:{
            "firstForecastExchangeRate": { $arrayElemAt: ["$ForecastExchangeRates", 0] }
        }
    },
    {
        $set: {
            $id{Forecast Currencies View.GBP Rate}: {
                $cond: {
                    if: { $eq: [ $$id{Forecast Currencies View.Symbol}, "Â£"] },
                    then: 1,
                    else: "$firstForecastExchangeRate._id{Metrics GBP Forex Daily.GBP Rate}"
                }
            }
        }
    }
]